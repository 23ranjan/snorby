<% content_for :header do %>
	<script type="text/javascript">
		<% unless Event.last.blank? %>
		
			var last_event = <%= Event.last.json_time %>;
			$('div#wrapper').attr({last_event: last_event.time});
		
			setInterval (function () {
				$.get('/events/last', function(data) {
					var old_id = $('div#wrapper').attr('last_event');
					var page = <%= params[:page].to_i %>;
					if (old_id != data.time) {
						$.get('events/since', {timestamp: old_id}, function (data) {
							if (data.events.length != 0) {
								if (page <= 1) { 
									if ($('div.new_events').length == 0) {
										$('#events').prepend('<div class="note new_events">New Events Are Available Click here To View Them.</div>');
									};
									$('#events ul.table div.content').prepend(Snorby.templates.event_table(data));
								};
								Snorby.notification({title: 'New Events', text: data.events.length + ' Events Added.'});
							};
						});
						$('div#wrapper').attr('last_event', data.time)
					};
				});
			}, 20000);
		<% end %>
	</script>
	
<% end %>

<% content_for :footer do %>
	<%= render :partial => 'layouts/notify' %>
<% end %>

<%= title "Listing Events", do -%>

	<li>&nbsp;</li>
	<li>
		<%= link_to "#{image_tag('icons/export.png')} Export".html_safe, '#', :class => 'has_dropdown', :id => 'export' %>
		<dl id='export' class='drop-down-menu' style='display:none;'>
			<dd><%= link_to "Export JSON", '#' %></dd>
			<dd>Export XML</dd>
			<dd>Export CSV</dd>
		</dl>
	</li>
	
	<li>
		<%= link_to "#{image_tag('icons/fp.png')} False Positive".html_safe, '#' %>
	</li>
	
	<li>
		<%= link_to "#{image_tag('icons/incident.png')} Incident".html_safe, '#', :class => 'has_dropdown', :id => 'incident' %>
		<dl id='incident' class='drop-down-menu' style='display:none;'>
			<dd>1</dd>
			<dd>2</dd>
			<dd>3</dd>
			<dd>3</dd>
			<dd>3</dd>
			<dd>3</dd>
			<dd>3</dd>
			<dd>3</dd>
		</dl>
	</li>
	
	<li>&nbsp;</li>
	
<%- end -%>

<div id="events" class='grid_12'>
	
	<%= form_tag '/events/select' do %>
	
	<ul class='table'>
		
		<li class='header'>
			<div class='row'>
				<div class='small'><%= check_box_tag 'event-select-all', nil, false, :class => 'event-select-all' %></div>
				<div class='small'>&nbsp;</div>
				<div class='small'>Sev.</div>
				<div class='address'>Sensor</div>
				<div class='address'>Source IP</div>
				<div class='address'>Destination IP</div>
				<div class='signature'>Event Signature</div>
				<div class='timestamp'>&nbsp;</div>
			</div>
		</li>
		
		<div class='content'>
			<%= render @events %>
		</div>
		
	</ul>
	
	<% end %>
	
	<%= pager(@events) %>
	
</div>